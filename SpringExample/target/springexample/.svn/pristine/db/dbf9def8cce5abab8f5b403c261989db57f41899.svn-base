<%@ page language="java" contentType="text/html; charset=GBK"  pageEncoding="GBK"%>
<%@ page import="
java.util.HashMap,
java.util.ArrayList,
java.util.Iterator,
com.sohu.frontweb.apollo.service.ApolloService,
com.sohu.frontweb.apollo.data.DataInfo,
com.sohu.frontweb.ParameterWrapper,
java.net.URLDecoder,
java.net.URLEncoder
"
%>  
<% 

	ParameterWrapper pw = new ParameterWrapper();
	pw.init(request);

	String url=pw.getStringParameter("url","http://*.sogou.com/");
	String inMd5=pw.getStringParameter("inMd5","top");
	String outMd5=pw.getStringParameter("outMd5","top");
	String endDate = pw.getStringParameter("date","20101027");

	/*String pUrl = pw.getStringParameter("pUrl","http://*.sogou.com/");
	String pMd5 = pw.getStringParameter("pMd5","top");
	String flow = pw.getStringParameter("flow","");		
	String url = pw.getStringParameter("url","http://*.sogou.com/");
	
	String md5 = pw.getStringParameter("md5","top");*/
	String type = pw.getStringParameter("type","url");
	
	String tUrl = url;
	if(type.equals("prefix")){
		if(tUrl.indexOf("*")==-1){
			if(url.indexOf("http://")==-1)
				url = "http://"+url;
			if(!tUrl.endsWith("/*"))
				if(!tUrl.endsWith("/"))
					url += "/*";
				else
					url += "*";
		}
	}

	StringBuffer categories = new StringBuffer();
	
	StringBuffer inPie = new StringBuffer();
	StringBuffer inBar = new StringBuffer();
	StringBuffer outPie = new StringBuffer();
	StringBuffer outBar = new StringBuffer();	
	

	String[] colorArr = new String[]{"1160B8","F2AC0C","BF0000","00247C","008900","E95D0F"};
	
	/*String inUrl=url;
	String inMd5 = md5;
	String outUrl=url;
	String outMd5 = md5;

	if(flow.equals("in")){
		outUrl = pUrl;
		outMd5 = pMd5;
		inUrl = pUrl;
	
	}else if(flow.equals("out")){
		inUrl = pUrl;
		inMd5 = pMd5;
		outUrl = pUrl;
	}*/
	
	
	ArrayList<DataInfo> inList = ApolloService.getFlowIn(url,inMd5,endDate);
	
	for(DataInfo data : inList){
		inPie.append("<set label=\\\""+ data.getUrl2() +"\\\" toolText=\\\""+ data.getUrl2()+":"+ data.getUrlPv() +"\\\" value=\\\""+data.getUrlPv()+"\\\" isSliced=\\\"0\\\" ");
		inBar.append("<set label=\\\""+ data.getUrl2() +"\\\" toolText=\\\""+ data.getUrl2()+":"+ data.getUrlPv() +"\\\" value=\\\""+data.getUrlPv()+"\\\" ");
		
		if(!data.getMd5().equals("none")&&!data.getMd5().equals("other")){
			//inPie.append("link=\\\"JavaScript:searchInfo('"+ URLEncoder.encode(data.getUrl2()) +"','"+ data.getMd5() +"','"+ data.getDate()  +"','in','"+URLEncoder.encode(url)+"','"+md5+"');\\\"");
			//inBar.append("link=\\\"JavaScript:searchInfo('"+ URLEncoder.encode(data.getUrl2()) +"','"+ data.getMd5() +"','"+ data.getDate()  +"','in','"+URLEncoder.encode(url)+"','"+md5+"');\\\"");
			inPie.append("link=\\\"JavaScript:searchInfo('"+ URLEncoder.encode(url)+"','"+data.getMd5() +"','"+outMd5+"','"+ data.getDate() +"');\\\"");
			inBar.append("link=\\\"JavaScript:searchInfo('"+ URLEncoder.encode(url)+"','"+data.getMd5() +"','"+outMd5+"','"+ data.getDate() +"');\\\"");

		
		}
		
		inPie.append("/>\\\n");
		inBar.append("/>\\\n");
		
			
	}
	
	ArrayList<DataInfo> outList = ApolloService.getFlowOut(url,outMd5,endDate);
	for(DataInfo data : outList){
		outPie.append("<set label=\\\""+ data.getUrl2() +"\\\" toolText=\\\""+ data.getUrl2()+":"+ data.getUrlPv() +"\\\" value=\\\""+data.getUrlPv()+"\\\" isSliced=\\\"0\\\" ");
		outBar.append("<set label=\\\""+ data.getUrl2() +"\\\" toolText=\\\""+ data.getUrl2()+":"+ data.getUrlPv() +"\\\" value=\\\""+data.getUrlPv()+"\\\" ");
		
		if(!data.getMd5().equals("none")&&!data.getMd5().equals("other")){
			outPie.append("link=\\\"JavaScript:searchInfo('"+ URLEncoder.encode(url) +"','"+ inMd5+"','"+data.getMd5()+"','"+ data.getDate() +"'));\\\"");
			outBar.append("link=\\\"JavaScript:searchInfo('"+ URLEncoder.encode(url) +"','"+ inMd5+"','"+data.getMd5()+"','"+ data.getDate() +"');\\\"");
		
		}
		
		outPie.append("/>\\\n");
		outBar.append("/>\\\n");
			
	}
	
	
%> 
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<style>

#seachTable{font-size:16px;}
#mainDiv ul{}
#mainDiv ul li{margin:20px 20px 0px 0px;}
.chartDiv{margin-top:20px;}
</style>
</head>   
<body>
<table border=0 width=100% align="center" style="font-size:14px;text-align:center;margin-top:20px;">

<tr>
	<td>	
	<div id="flowOutBar_chartdiv"> </div>
	</td>
	<td>	
	<div id="flowOutPie_chartdiv"> </div>
	</td>

</tr>
<tr>
	<td>	
	<div id="flowInBar_chartdiv"> </div>
	</td>
	<td>	
	<div id="flowInPie_chartdiv"> </div>
	</td>
</tr>
</table>

<script type="text/javascript">
function searchInfo(url,inMd5,outMd5,date){
	var searchUrl = 'apollo/flow.jsp?r='+Math.random()
					+"&url="+escape(url)+"&inMd5="+inMd5+"&outMd5="+outMd5+"&date="+date;
	
	p.load({
					url: searchUrl,
					callback : function(){
						//document.getElementById("url0").value=url;
						//document.getElementById("endDate").value=date;
					},
					scripts: true
	});
}

var inPieXml = "<chart caption=\"流入 分布\" palette=\"2\"  animation=\"1\" subCaption=\"\" YAxisName=\"\" showValues=\"1\" formatNumberScale=\"0\" showPercentInToolTip=\"1\" showLabels=\"0\" showLegend=\"0\" showPercentValues=\"1\">" +
				"<%=inPie.toString()%>"+
				 "<styles><definition><style type=\"font\" name=\"CaptionFont\" color=\"666666\" size=\"15\" /><style type=\"font\" name=\"SubCaptionFont\" bold=\"0\" /></definition>" +
				 "<application><apply toObject=\"caption\" styles=\"CaptionFont\"/> <apply toObject=\"SubCaption\" styles=\"SubCaptionFont\" /></application>" +
				 "</styles></chart>";

var inBarXml = "<chart caption='流入 分布' yAxisName='' xAxisName='' bgColor='F1F1F1' showValues='1' canvasBorderThickness='1' formatNumberScale=\"0\" canvasBorderColor='999999'  plotFillAngle='330' plotBorderColor='999999' showAlternateVGridColor='1' divLineAlpha='0' setAdaptiveYMin='1' >"+
				"<%=inBar.toString()%>"+
				"</chart>";			
	

var outPieXml = "<chart caption=\"流出 分布\" palette=\"2\"  animation=\"1\" subCaption=\"\" YAxisName=\"\" showValues=\"1\" formatNumberScale=\"0\" showPercentInToolTip=\"1\" showLabels=\"0\" showLegend=\"0\" showPercentValues=\"1\">" +
				"<%=outPie.toString()%>"+
				 "<styles><definition><style type=\"font\" name=\"CaptionFont\" color=\"666666\" size=\"15\" /><style type=\"font\" name=\"SubCaptionFont\" bold=\"0\" /></definition>" +
				 "<application><apply toObject=\"caption\" styles=\"CaptionFont\"/> <apply toObject=\"SubCaption\" styles=\"SubCaptionFont\" /></application>" +
				 "</styles></chart>";

var outBarXml = "<chart caption='流出 分布' yAxisName='' xAxisName='' bgColor='F1F1F1' showValues='1' canvasBorderThickness='1' formatNumberScale=\"0\" canvasBorderColor='999999'  plotFillAngle='330' plotBorderColor='999999' showAlternateVGridColor='1' divLineAlpha='0' setAdaptiveYMin='1' >"+
				"<%=outBar.toString()%>"+
				"</chart>";		
	
			 				 	
	      
		   var chart = new FusionCharts("flash/FUSIONCHARTS.COM/Pie3D.swf", "ChartId", "100%", "350", "0", "0");
		   //chart.setXMLUrl("apollo/Bar2D1.xml");		   
		   chart.setXMLData(inPieXml);
		   chart.render("flowInPie_chartdiv");
			
			
		   var chart = new FusionCharts("flash/FUSIONCHARTS.COM/Bar2D.swf", "ChartId", "100%", "350", "0", "0");
		   chart.setXMLData(inBarXml);
		   chart.render("flowInBar_chartdiv");
		   
		   var chart = new FusionCharts("flash/FUSIONCHARTS.COM/Pie3D.swf", "ChartId", "100%", "350", "0", "0");
		   //chart.setXMLUrl("apollo/Bar2D1.xml");		   
		   chart.setXMLData(outPieXml);
		   chart.render("flowOutPie_chartdiv");
			
			
		   var chart = new FusionCharts("flash/FUSIONCHARTS.COM/Bar2D.swf", "ChartId", "100%", "350", "0", "0");
		   chart.setXMLData(outBarXml);
		   chart.render("flowOutBar_chartdiv");		   
		   /*
		   
	  	   var chart = new FusionCharts("flash/chart/Pie3D.swf", "ChartId", "50%", "350", "0", "0");
		   //chart.setXMLData(ctrTrendXml);	   
		   chart.render("ctrTrend_chartdiv");		
		   
		   var chart = new FusionCharts("flash/chart/Bar2D.swf", "ChartId", "50%", "350", "0", "0");
		  //chart.setXMLData(absPvTrendXml);		   
		   chart.render("absPvTrend_chartdiv");		
		   */
		   <%
		   //if(flow.isEmpty()){
		   	 out.println("document.getElementById('url0').value='"+ url +"'");
		   //}
		   %>
	   
</script>	
</body>
</html>