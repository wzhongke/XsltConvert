<%@ page language="java" contentType="text/html; charset=GBK"  pageEncoding="GBK"%>
<%@ page import="
java.util.HashMap,
java.util.ArrayList,
java.util.Iterator,
com.sohu.frontweb.apollo.service.ApolloService,
com.sohu.frontweb.apollo.data.DataInfo,
com.sohu.frontweb.ParameterWrapper
"
%>  
<% 

	ParameterWrapper pw = new ParameterWrapper();
	pw.init(request);
		
	String urls = pw.getStringParameter("urls","http://www.sogou.com/*|http://www.baidu.com/*| | | | |");
	String startDate = pw.getStringParameter("startDate","20101020");
	String endDate = pw.getStringParameter("endDate","20101027");
	String type = pw.getStringParameter("type","url");

	StringBuffer categories = new StringBuffer();
	
	StringBuffer pvTrend = new StringBuffer();
	StringBuffer uvTrend = new StringBuffer();
	StringBuffer absPvTrend = new StringBuffer();
	StringBuffer absUvTrend = new StringBuffer();
	StringBuffer ctrTrend = new StringBuffer();


	String[] urlArr = urls.split("\\|");
	String[] colorArr = new String[]{"1160B8","F2AC0C","BF0000","00247C","008900","E95D0F"};
	
	int i = 0;
	int j = 0;
	for(String url:urlArr){
		if(url.trim().equals(""))
			continue;
		
		String tUrl = url;
		if(type.equals("prefix")){
			if(tUrl.indexOf("*")==-1){
				if(url.indexOf("http://")==-1)
					url = "http://"+url;
				if(!tUrl.endsWith("/*"))
					if(!tUrl.endsWith("/"))
						url += "/*";
					else
						url += "*";
			}
		}			
			
		ArrayList<DataInfo> dataList = ApolloService.getUrlTrend(url,startDate,endDate);
		
		
		if(i==0)	
			categories.append("<categories>");
		pvTrend.append("<dataset seriesName='"+url+"' color='"+colorArr[i]+"'>");
		uvTrend.append("<dataset seriesName='"+url+"' color='"+colorArr[i]+"'>");
		absPvTrend.append("<dataset seriesName='"+url+"' color='"+colorArr[i]+"'>");
		absUvTrend.append("<dataset seriesName='"+url+"' color='"+colorArr[i]+"'>");
		ctrTrend.append("<dataset seriesName='"+url+"' color='"+colorArr[i]+"'>");
		
		j=dataList.size();
		
		for(int a = dataList.size()-1;a>=0;a--){
			DataInfo dataInfo = dataList.get(a);
				if(i==0)	
					categories.append("<category label='"+dataInfo.getDate()+"'/>");
				pvTrend.append("<set value='"+dataInfo.getTotalPv()+"'/>");	
				uvTrend.append("<set value='"+dataInfo.getTotalUv()+"'/>");
				absPvTrend.append("<set value='"+dataInfo.getUrlPv()+"'/>");	 
				absUvTrend.append("<set value='"+dataInfo.getUrlUv()+"'/>");	 
				ctrTrend.append("<set value='"+dataInfo.getCtr()+"'/>");	 
				
		}
		
		pvTrend.append("</dataset>");
		uvTrend.append("</dataset>");
		absPvTrend.append("</dataset>");
		absUvTrend.append("</dataset>");
		ctrTrend.append("</dataset>");
			
		if(i==0)	
			categories.append("</categories>");	
		i++;
	}
%> 
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<style>

#seachTable{font-size:16px;}
#mainDiv ul{}
#mainDiv ul li{margin:20px 20px 0px 0px;}
.chartDiv{margin-top:20px;}
</style>
</head>   
<body>
<table border=0 width=100% style="font-size:14px;text-align:center;margin-top:10px;">
<tr>
	<td>	
	<div id="pvTrend_chartdiv"> </div>
	</td>
</tr>

<tr>
	<td>	
	<div id="ctrTrend_chartdiv"> </div>
	</td>
</tr>

<tr>
	<td>	
	<div id="absPvTrend_chartdiv"> </div>
	</td>
</tr>

<tr>
	<td>	
	<div id="absUvTrend_chartdiv"> </div>
	</td>
</tr>

</table>

<script type="text/javascript">
function searchInfo(){

	var searchUrl = 'apollo/trend.jsp?r='+Math.random();
	
	var urls = "";
	for(var i = 0;i<6;i++){
		//if(document.getElementById("url"+i).value)
		urls += encodeURIComponent(document.getElementById("url"+i).value)+"|";
	}
	
	//alert(urls);
	var startDate = document.getElementById("startDate").value;
	var endDate = document.getElementById("endDate").value;
	var type = document.getElementById("type").value;
			
	searchUrl += "&urls="+urls+"&startDate="+startDate+"&endDate="+endDate+"&type="+type;
	loadMainContentByUrl(searchUrl);
	return false;

}

var pvTrendXml = "<chart palette='2' caption='PV趋势 （每亿PV）' showValues='1' formatNumberScale='0' numVDivLines='<%=(j-2)%>' drawAnchors='0' numberPrefix='' divLineAlpha='30' alternateHGridAlpha='20' setAdaptiveYMin='1'>\n"+
				 "<%=categories.toString()+pvTrend.toString()%>"+
				 "<styles><definition>"+
				 "<style name='XScaleAnim' type='ANIMATION' duration='0.5' start='0' param='_xScale' />"+
				 "<style name='YScaleAnim' type='ANIMATION' duration='0.5' start='0' param='_yscale' />"+
				 "<style name='XAnim' type='ANIMATION' duration='0.5' start='0' param='_yscale' />"+
				 "<style name='AlphaAnim' type='ANIMATION' duration='0.5' start='0' param='_alpha' />"+
				 "</definition>"+
				 "<application>"+
				 "<apply toObject='CANVAS' styles='XScaleAnim, YScaleAnim,AlphaAnim' />"+
				 "<apply toObject='DIVLINES' styles='XScaleAnim,AlphaAnim' />"+
				 "<apply toObject='VDIVLINES' styles='YScaleAnim,AlphaAnim' />"+
				 "<apply toObject='HGRID' styles='YScaleAnim,AlphaAnim' />"+			    
				 "</application>"+
				 "</styles></chart>";
	
var uvTrendXml = "<chart palette='2' caption='UV趋势 （每亿PV）' showValues='1' formatNumberScale='0' numVDivLines='<%=(j-2)%>' drawAnchors='0' numberPrefix='' divLineAlpha='30' alternateHGridAlpha='20' setAdaptiveYMin='1'>\n"+
				 "<%=categories.toString()+uvTrend.toString()%>"+
				 "<styles><definition>"+
				 "<style name='XScaleAnim' type='ANIMATION' duration='0.5' start='0' param='_xScale' />"+
				 "<style name='YScaleAnim' type='ANIMATION' duration='0.5' start='0' param='_yscale' />"+
				 "<style name='XAnim' type='ANIMATION' duration='0.5' start='0' param='_yscale' />"+
				 "<style name='AlphaAnim' type='ANIMATION' duration='0.5' start='0' param='_alpha' />"+
				 "</definition>"+
				 "<application>"+
				 "<apply toObject='CANVAS' styles='XScaleAnim, YScaleAnim,AlphaAnim' />"+
				 "<apply toObject='DIVLINES' styles='XScaleAnim,AlphaAnim' />"+
				 "<apply toObject='VDIVLINES' styles='YScaleAnim,AlphaAnim' />"+
				 "<apply toObject='HGRID' styles='YScaleAnim,AlphaAnim' />"+			    
				 "</application>"+
				 "</styles></chart>";
				 
var ctrTrendXml = "<chart palette='2' caption='CRT趋势' showValues='1' formatNumberScale='0' numVDivLines='<%=(j-2)%>' drawAnchors='0' numberPrefix='' divLineAlpha='30' alternateHGridAlpha='20' setAdaptiveYMin='1'>\n"+
				 "<%=categories.toString()+ctrTrend.toString()%>"+
				 "<styles><definition>"+
				 "<style name='XScaleAnim' type='ANIMATION' duration='0.5' start='0' param='_xScale' />"+
				 "<style name='YScaleAnim' type='ANIMATION' duration='0.5' start='0' param='_yscale' />"+
				 "<style name='XAnim' type='ANIMATION' duration='0.5' start='0' param='_yscale' />"+
				 "<style name='AlphaAnim' type='ANIMATION' duration='0.5' start='0' param='_alpha' />"+
				 "</definition>"+
				 "<application>"+
				 "<apply toObject='CANVAS' styles='XScaleAnim, YScaleAnim,AlphaAnim' />"+
				 "<apply toObject='DIVLINES' styles='XScaleAnim,AlphaAnim' />"+
				 "<apply toObject='VDIVLINES' styles='YScaleAnim,AlphaAnim' />"+
				 "<apply toObject='HGRID' styles='YScaleAnim,AlphaAnim' />"+			    
				 "</application>"+
				 "</styles></chart>";
				 
				 
var absPvTrendXml = "<chart palette='2' caption='绝对PV趋势' showValues='1' formatNumberScale='0' numVDivLines='<%=(j-2)%>' drawAnchors='0' numberPrefix='' divLineAlpha='30' alternateHGridAlpha='20' setAdaptiveYMin='1'>\n"+
				 "<%=categories.toString()+absPvTrend.toString()%>"+
				 "<styles><definition>"+
				 "<style name='XScaleAnim' type='ANIMATION' duration='0.5' start='0' param='_xScale' />"+
				 "<style name='YScaleAnim' type='ANIMATION' duration='0.5' start='0' param='_yscale' />"+
				 "<style name='XAnim' type='ANIMATION' duration='0.5' start='0' param='_yscale' />"+
				 "<style name='AlphaAnim' type='ANIMATION' duration='0.5' start='0' param='_alpha' />"+
				 "</definition>"+
				 "<application>"+
				 "<apply toObject='CANVAS' styles='XScaleAnim, YScaleAnim,AlphaAnim' />"+
				 "<apply toObject='DIVLINES' styles='XScaleAnim,AlphaAnim' />"+
				 "<apply toObject='VDIVLINES' styles='YScaleAnim,AlphaAnim' />"+
				 "<apply toObject='HGRID' styles='YScaleAnim,AlphaAnim' />"+			    
				 "</application>"+
				 "</styles></chart>";
				 
		
var absUvTrendXml = "<chart palette='2' caption='绝对UV趋势' showValues='1' formatNumberScale='0' numVDivLines='<%=(j-2)%>' drawAnchors='0' numberPrefix='' divLineAlpha='30' alternateHGridAlpha='20' setAdaptiveYMin='1'>\n"+
				 "<%=categories.toString()+absUvTrend.toString()%>"+
				 "<styles><definition>"+
				 "<style name='XScaleAnim' type='ANIMATION' duration='0.5' start='0' param='_xScale' />"+
				 "<style name='YScaleAnim' type='ANIMATION' duration='0.5' start='0' param='_yscale' />"+
				 "<style name='XAnim' type='ANIMATION' duration='0.5' start='0' param='_yscale' />"+
				 "<style name='AlphaAnim' type='ANIMATION' duration='0.5' start='0' param='_alpha' />"+
				 "</definition>"+
				 "<application>"+
				 "<apply toObject='CANVAS' styles='XScaleAnim, YScaleAnim,AlphaAnim' />"+
				 "<apply toObject='DIVLINES' styles='XScaleAnim,AlphaAnim' />"+
				 "<apply toObject='VDIVLINES' styles='YScaleAnim,AlphaAnim' />"+
				 "<apply toObject='HGRID' styles='YScaleAnim,AlphaAnim' />"+			    
				 "</application>"+
				 "</styles></chart>";				 				 				 	
	      
		   var chart = new FusionCharts("flash/FUSIONCHARTS.COM/MSLine.swf", "ChartId", "100%", "350", "0", "0");
		   //chart.setXMLUrl("apollo/xml?chart=pvTrend");		   
		   chart.setXMLData(pvTrendXml);
		   chart.render("pvTrend_chartdiv");

		   var chart = new FusionCharts("flash/FUSIONCHARTS.COM/MSLine.swf", "ChartId", "100%", "350", "0", "0");
		   chart.setXMLData(uvTrendXml);
		   chart.render("uvTrend_chartdiv");
		   
	  	   var chart = new FusionCharts("flash/FUSIONCHARTS.COM/MSLine.swf", "ChartId", "100%", "350", "0", "0");
		   chart.setXMLData(ctrTrendXml);	   
		   chart.render("ctrTrend_chartdiv");		
		   
		   var chart = new FusionCharts("flash/FUSIONCHARTS.COM/MSLine.swf", "ChartId", "100%", "350", "0", "0");
		   chart.setXMLData(absPvTrendXml);		   
		   chart.render("absPvTrend_chartdiv");		

		   var chart = new FusionCharts("flash/FUSIONCHARTS.COM/MSLine.swf", "ChartId", "100%", "350", "0", "0");
		   chart.setXMLData(absUvTrendXml);	   
		   chart.render("absUvTrend_chartdiv");	
			   
</script>	
</body>
</html>