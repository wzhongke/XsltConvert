<%@ page language="java" contentType="text/html; charset=GBK"
    pageEncoding="GBK"%>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=GBK">
	<title>问答query黑名单记录列表</title>
</head>
<script type="text/javascript">
	Ext.namespace('Ext.exampledata');
	Ext.exampledata.matchrule_list = [
 		['2','2级:模糊文字匹配', 'The Heart of Dixie'],
        ['3','3级:精确文字匹配', 'The Land of the Midnight Sun']
     ];
	Ext.onReady(function(){
		//创建新增或单独修改表记录信息的form表单
		Ext.QuickTips.init();
		Ext.form.Field.prototype.msgTarget = 'side';//统一指定错误信息提示方式


		var exportConditionUrl = 'query_webpage_wenda.do?method=getRecordList';


		
		//定义数据集对象
		var store = new Ext.data.Store({//配置分组数据集
			reader: new Ext.data.XmlReader({
				totalRecords: "results",
				record: "QueryWendaRecord",
				id: "id"
			},
			Ext.data.Record.create([
				{name: 'id'},
				{name: 'url'},
				{name: 'url_type'},
				{name: 'synchronized_tag'},
				{name: 'sub_user'},
				{name: 'sub_date', type: 'date', dateFormat: 'Y-m-d H:i:s'}
			])
			),
			proxy : new Ext.data.HttpProxy({
				url : 'query_webpage_wenda.do?method=getRecordList'
			}),
			sortInfo: {field: 'sub_date', direction: 'DESC'},
	  		remoteSort: true
		})





		
		
		<%//根据权限信息显示工具栏
		StringBuffer toolbar_str = new StringBuffer();
    	toolbar_str.append("{text : '新增',iconCls:'add',handler : showAdd},");
    	toolbar_str.append("{text : '修改',iconCls:'option',handler : showModify},");
    	toolbar_str.append("{text : '删除',iconCls:'remove',handler : showDelete},");
	    toolbar_str.deleteCharAt(toolbar_str.length()-1);
	    %>
		//创建工具栏组件
		var toolbar = new Ext.Toolbar([
		    <%=toolbar_str.toString()%>
		]);
    	
    	//创建分页工具栏
    	var pagingBar = new Ext.PagingToolbar({
	        pageSize: 18,
	        store: store,
	        displayInfo: true,
	        displayMsg: '显示 {0} - {1} , 共 {2} 条记录',
	        emptyMsg: "没有任何记录",
	        items:[{text : '导出',iconCls:'option',handler : exportExcel}]
    	});
		//创建Grid表格组件
		var cb = new Ext.grid.CheckboxSelectionModel();
		//创建过滤器
		var filters = new Ext.grid.GridFilters({
		  filters:[
		    {type: 'numeric',  dataIndex: 'id'},
		    {type: 'string',  dataIndex: 'url'},
		    {type: 'boolean', dataIndex: 'tag_block'},
		    {type: 'boolean', dataIndex: 'tag_reversible'},
		    {
		      type: 'list',  
		      dataIndex: 'extra_attr', 
		      options: ['无价值', '死链', '非中文'],
		      phpMode: true
		    },
		    {type: 'string',  dataIndex: 'user'},
		    {type: 'date',  dataIndex: 'sub_date'},
		    {type: 'string',  dataIndex: 'info'}
		]});





		

		var dr = new Ext.FormPanel({
	    	labelWidth: 125,
	        frame: true,
	        width: 960,
	  	  	bodyStyle:'padding:5px 5px 0',
	        defaults: {width: 175},
	      	//增加表单键盘事件
	        keys:[
	         {
	             key: [10,13],
	             fn:query
	         } ],
	        items: [{
	        	xtype:'textfield',
				width : 400,
				id : 'query_url',
				name : 'query_url',
				fieldLabel:'URL'
	        },

	        {
	            layout:'column',
	            width : 800,
	            border:false,
	            items:[
	                {
	                    columnWidth:.5,
	                    layout: 'form',
	                    border:false,
	                    items: [{
	                        xtype:'radio',
	                        fieldLabel:'查找方式',
	                        boxLabel:'精确查找',
	                        name:'query_matchType',
	                        anchor:'100%',
	                        inputValue: 1
	                    }]
	                },
	                {   
	                    columnWidth:.5,
	                    layout: 'form',
	                    border:false,
	                    items: [{
	                        xtype:'radio',
	                        boxLabel:'模糊查找',
	                        checked: true,
	                        hideLabel: true,
	                        name:'query_matchType',
	                        anchor:'100%',
	                        inputValue: 0
	                    }]
	                }
	              ]
            },
            {
        	    layout:'column',
        	    width : 620,
        	    border:false,
        	    items:[
        	        {
        	            columnWidth:.5,
        	            layout: 'form',
        	            border:false,
        	            items: [{
        	            	xtype:'textfield',
    						id : 'query_create_time_1',
    						name : 'query_create_time_1',
    						fieldLabel:'提交日期',
    						cls:'Wdate'
        	            }]
        	        },
        	        {
        	            columnWidth:.5,
        	            layout: 'form',
        	            border:false,
        	            items: [{
        	            	xtype:'textfield',
    						id : 'query_create_time_2',
    						name : 'query_create_time_2',
    						fieldLabel:'到',
    						cls:'Wdate'
        	            }]
        	        }
        	      ]
        	},
        	{
			    layout:'column',
			    width : 930,
			    border:false,
			    items:[
			        	{
	                        layout:'form',
	                        columnWidth:.35,
	                        border:false,
	                        items:[
	                                {
	                                    xtype:'textfield',
                                        id : 'query_sub_user',
                                        name : 'query_sub_user',
                                        fieldLabel:'提交人'
	                                }
	                            ]
	                    },{
						    layout:'column',
						    columnWidth:.65,
						    border:false,
						    items:[
									{
							            columnWidth:.5,
							            layout: 'form',
							            border:false,
							            items: [{
							                xtype: 'radio',
							                labelSeparator: '',
							                checked : true,
							                labelStyle: 'width: 85px;',
							                boxLabel: '全部',
							                name: 'query_url_type',
							                inputValue: -100,
							                hidden : true
							            }]
							        },
							        {   
							            columnWidth:.25,
							            layout: 'form',
							            border:false,
							            items: [{
							                xtype: 'radio',
							                fieldLabel: '',
							                hideLabel: true,
							                labelSeparator: '',
							                boxLabel: 'Url',
							                name: 'query_url_type',
							                inputValue: 0,
							                hidden : true
							            }]
							        },
							        {   
							            columnWidth:.25,
							            layout: 'form',
							            border:false,
							            items: [{
							                xtype: 'radio',
							                fieldLabel: '',
							                hideLabel: true,
							                labelSeparator: '',
							                boxLabel: 'Site',
							                name: 'query_url_type',
							                inputValue: 1,
							                hidden : true
							            }]
							        }
						      ]
						}
					]
        	}],
			buttons:[
				{
					text : '查询',
					handler : function(){
						query(true);
					}
				},
				{
					text : '返回',
					handler : function(){
						query(false);
					}
				}
			]
	      });




		
		
		var recordGrid = new Ext.grid.GridPanel({
			applyTo : 'grid-div',
			tbar : toolbar,
			frame:true,
			loadMask: true,
			//plugins: filters,
			autoScroll: true,
			autoWidth:true,
			//width: 960,
			store: store,
			viewConfig : {
				autoFill : true
			},
			sm : cb,
			columns: [//配置表格列
				new Ext.grid.RowNumberer({
					header : '行号',
					width : 40
				}),//表格行号组件
				cb,
				{header: "编号", width: 30, dataIndex: 'id', sortable: true},
				{header: "同步状态", width: 30, dataIndex: 'synchronized_tag', sortable: true},
				{header: "URL", width: 200, dataIndex: 'url', sortable: true},
				//{header: "URL类型", width: 30, dataIndex: 'url_type', renderer:urltype, sortable: true},
				{header: "提交者", width: 75, dataIndex: 'sub_user', sortable: true},
				{header: "提交日期", width: 75, dataIndex: 'sub_date', renderer: Ext.util.Format.dateRenderer('Y-m-d H:i:s'), sortable: true}
			],
	        // paging bar on the bottom
	        bbar: pagingBar
			
		});
		// trigger the data store load
    	store.load({params:{start:0, limit:18}});




    	
		
		var inputForm = new Ext.FormPanel({
			labelSeparator : ":",
			frame:true,
			border:false,
			autoHeight: true,
			id : 'inputform',
			items : [
				{
					xtype:'textarea',
					width : 600,
					height : 150,
					name : 'url',
					fieldLabel:'<font color=red>*</font>URL<br><font color=red>（输入条目上限为100条，每条长度超过4096为不合法）</font>',
					allowBlank : false
				},{
                	xtype: 'radio',
                    checked: true,
                    labelSeparator: '',
                    boxLabel: 'Url',
                    name: 'url_type',
                    inputValue: 0,
                    hidden : true                    
                },{
                	xtype: 'radio',
                    fieldLabel: '',
                    labelSeparator: '',
                    boxLabel: 'Site',
                    name: 'url_type',
                    inputValue: 1,
                    hidden : true  
                },{
					xtype:'hidden',
					name : 'id'
				}
			],
			buttons:[
				{
					text : '提交',
					handler : submitForm
				},
				{
					text : '关闭',
					handler : function(){
						win.hide();
					}
				}
			]
		});

		//删除原有窗口对象
		win = Ext.getCmp('input_window');
		if(win){
			win.destroy();
		}
		
		//创建弹出窗口
		var win = new Ext.Window({
			id: 'input_window',
			layout:'fit',
		    width:800,
		    closeAction:'hide',
			resizable : false,
			shadow : true,
			modal :true,
		    closable:true,
		    bodyStyle:'padding:5 5 5 5',
		    animCollapse:true,
			items:[inputForm]
		});

		//显示新建域名表记录窗口
		function showAdd(){
			inputForm.form.reset();
			inputForm.isAdd = true;
			win.setTitle("新增记录信息");
			win.show();
		}
		//显示修改域名表记录窗口
		function showModify(){
			var recordList = getCheckedIdList();
			var num = recordList.length;
			if(num > 1){
				Ext.MessageBox.alert("提示","每次只能修改一条记录信息。")
			}else if(num == 1){
				inputForm.isAdd = false;
				win.setTitle("修改记录信息");
				win.show();
				var recordId = recordList[0];
				loadForm(recordId);
			}
		}
		//加载表单数据
		function loadForm(recordId){
			inputForm.form.load({
				waitMsg : '正在加载数据请稍后',//提示信息
				waitTitle : '提示',//标题
				url : 'query_webpage_wenda.do?method=getRecordById',//请求的url地址
				params : {recordId : recordId},
				method:'GET',//请求方式
				success:function(form,action){//加载成功的处理函数
				},
				failure:function(form,action){//加载失败的处理函数
					Ext.Msg.alert('提示','数据加载失败');
				}
			});
		}
		//显示删除域名表记录对话框
		function showDelete(){
			var recordIdList = getCheckedIdList();
			var num = recordIdList.length;
			if(num == 0){
				return;
			}
			Ext.MessageBox.confirm("提示","您确定要删除所选记录吗？",function(btnId){
				if(btnId == 'yes')
					deleteRecord(recordIdList);
			})
		}
		//删除域名表记录
		function deleteRecord(recordIdList){
			var msgTip = Ext.MessageBox.show({
				title:'提示',
				width : 250,
				msg:'正在删除问答query表记录信息请稍后......'
			});
			Ext.Ajax.request({
				url : 'query_webpage_wenda.do?method=deleteRecord',
				params : {recordIdList : recordIdList.toString()},
				method : 'POST',
				success : function(response,options){
					msgTip.hide();
					var result = Ext.util.JSON.decode(response.responseText);
					if(result.success){
						//服务器端数据成功删除后，同步删除客户端列表中的数据
						store.load({params:{start:0, limit:18}});
						Ext.Msg.alert('提示','删除问答query表记录信息成功。');
					}else{
						Ext.Msg.alert('提示','该问答query表记录已包含'+result.num+'本书籍信息不能删除！');
					}
				},
				failure : function(response,options){
					msgTip.hide();
					Ext.Msg.alert('提示','删除问答query表记录请求失败！');
				}
			});
		}
		
		//提交表单数据
		function submitForm(){
			//判断当前执行的提交操作，isAdd为true表示执行域名表记录新增操作，false表示执行域名表记录修改操作
			if( inputForm.form.isValid() ){
				if(inputForm.isAdd){
					//新增域名表记录信息
					inputForm.form.submit({
						clientValidation:true,//进行客户端验证
						waitMsg : '正在提交数据请稍后',//提示信息
						waitTitle : '提示',//标题
						url : 'query_webpage_wenda.do?method=addRecord',//请求的url地址
						method:'POST',//请求方式
						success:function(form,action){//加载成功的处理函数
							win.hide();
							var failcause = action.result.cause;
							var conflict = action.result.conflict;
							Ext.MessageBox.show({
					           title: '提示',
					           msg: '完成新增问答query表记录操作。<br><br><br>' + failcause + '，包括如下记录：<br><textarea rows="10" cols="45" readonly="true">' + conflict + '</textarea>' , 
					           buttons: Ext.MessageBox.OK,
					           icon: Ext.MessageBox.INFO
					        });
							store.load({params:{start:0, limit:18}});
						},
						failure:function(form,action){//加载失败的处理函数
							win.hide();
							var failcause = action.result.cause;
							Ext.MessageBox.show({
					           title: '提示',
					           msg: '新增问答query表记录失败，原因是：<br>'+failcause,
					           buttons: Ext.MessageBox.OK,
					           icon: Ext.MessageBox.ERROR
					        });
						}
					});
				}else{
					//修改域名表记录信息
					inputForm.form.submit({
						clientValidation:true,//进行客户端验证
						waitTitle : '提示',//标题
						url : 'query_webpage_wenda.do?method=modifyRecord',//请求的url地址
						method:'POST',//请求方式
						success:function(form,action){//加载成功的处理函数
							win.hide();
							store.load({params:{start:0, limit:18}});
							Ext.Msg.alert('提示','修改问答query表记录成功');
						},
						failure:function(form,action){//加载失败的处理函数
							win.hide();
							var failcause = action.result.cause;
							Ext.MessageBox.show({
					           title: '提示',
					           msg: '修改问答query表记录失败。原因是:<br>'+failcause,
					           buttons: Ext.MessageBox.OK,
					           icon: Ext.MessageBox.ERROR
					        });
						}
					});
				}
			}//if( inputForm.form.isValid() )
		}
		//取得所选域名记录信息
		function getCheckedIdList(){
			var recs = recordGrid.getSelectionModel().getSelections();
			var list = [];
			if(recs.length == 0){
				Ext.MessageBox.alert('提示','请选择要进行操作的记录！');
			}else{
				for(var i = 0 ; i < recs.length ; i++){
					var rec = recs[i];
					list.push(rec.get('id'));
				}
			}
			return list;
		}
		//线上同步词表
		function synchronize(){
			var msgTip = Ext.MessageBox.show({
				title:'提示',
				width : 250,
				msg:'正在向线上发送问答query同步信号，请稍候......'
			});
			Ext.Ajax.request({
				url : 'query_webpage_wenda.do?method=deploy',
				params : {deploytype : 'query'},
				method : 'POST',
				success : function(response,options){
					msgTip.hide();
					Ext.Msg.alert('提示','词表线上同步中...');
					store.load({params:{start:0, limit:18}});
				},
				failure : function(response,options){
					msgTip.hide();
					Ext.Msg.alert('提示','词表线上同步失败！');
				}
			});
		}
		//将URL类型解析成 文本
		function urltype(val){
	        if(val == 1){
	            return 'Site';
	        }else if(val == 0){
	            return 'Url';
	        }else
		        return '';
    	}
		//导出Excel
		function exportExcel(){
			var msgTip = Ext.MessageBox.show({
				title:'提示',
				width : 250,
				msg:'正在导出问答query记录信息请稍候（上限1w条）......'
			});
			Ext.Ajax.request({
				url : 'query_webpage_wenda.do?method=exportRecord',
				params : {storeUrl : Ext.util.JSON.encode(exportConditionUrl) },
				method : 'POST',
				success : function(response,options){
					msgTip.hide();
					window.location = '<%=request.getContextPath()%>/exportExcel/blacklist_query_wenda.xls';
					var result = Ext.util.JSON.decode(response.responseText);
				},
				failure : function(response,options){
					msgTip.hide();
					Ext.Msg.alert('提示','导出问答query记录请求失败！');
				}
			});
		}
		//开始查询代码
		function query(tag){
			//新增域名表记录信息
			var query_url ;
			if(tag)
				query_url = document.getElementById("query_url").value;
			else{
				query_url = '';
				document.getElementById("query_url").value='';
			}
			var query_matchType;
			if(document.getElementsByName("query_matchType")[0].checked)
				query_matchType = 1;
			else
				query_matchType = 0;

			var query_create_time_1 = document.getElementById("query_create_time_1").value;
			var query_create_time_2 = document.getElementById("query_create_time_2").value;
			var query_sub_user = document.getElementById("query_sub_user").value;
			var query_url_type;
			if(document.getElementsByName("query_url_type")[0].checked)
				query_url_type = -100;
			else if(document.getElementsByName("query_url_type")[1].checked)
				query_url_type = 0;
			else
				query_url_type = 1;

			
			var url = "query_webpage_wenda.do?method=getRecordList&query_url="+escape(query_url)+"&query_matchType="+query_matchType
			+"&query_create_time_1=" + query_create_time_1 + "&query_create_time_2=" + query_create_time_2
			+ "&query_sub_user=" + escape(query_sub_user) + "&query_url_type=" + query_url_type;

			exportConditionUrl = "query_webpage_wenda.do?method=getRecordList&query_url="+query_url+"&query_matchType="+query_matchType
			+"&query_create_time_1=" + query_create_time_1 + "&query_create_time_2=" + query_create_time_2
			+ "&query_sub_user=" + query_sub_user + "&query_url_type=" + query_url_type;
			
			store.proxy.conn.url = url;
			store.load({params:{start:0, limit:18}});
		}
		
	    dr.render('dr');
	    Ext.get('query_create_time_1').on('click',function(){
			WdatePicker({skin:'ext',dateFmt:'yyyy-MM-dd HH:mm:ss',maxDate:'#F{$dp.$D(\'query_create_time_2\')}'});
		});
		Ext.get('query_create_time_2').on('click',function(){
			WdatePicker({skin:'ext',dateFmt:'yyyy-MM-dd HH:mm:ss',minDate:'#F{$dp.$D(\'query_create_time_1\')}'});
		});
	});
</script>
<body>
<div id="dr" style="width:100%;height:30%;"></div>
<div id='grid-div' style="width:100%; height:70%;"></div>
</body>
</html>